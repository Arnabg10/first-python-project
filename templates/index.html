<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Expense Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-container">
      {% for category, message in messages %}
        <div class="flash {{ category }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<!-- üîê AUTH NAV -->
<div class="auth-nav">
    {% if session.get("user_id") %}
        <span class="user-email">
            {{ session.get("user_email") }}
        </span>
        <a href="/logout" class="btn btn-logout">Logout</a>
    {% else %}
        <a href="/login" class="btn btn-login">Login</a>
        <a href="/signup" class="btn btn-signup">Sign Up</a>
    {% endif %}
</div>


<div class="app">

    <!-- HEADER -->
    <header class="header">
        <h1>Mintly</h1>
        <p>Track where your money goes</p>

        <!-- Dark mode toggle -->
        <button id="themeToggle" class="theme-toggle ripple" aria-label="Toggle dark mode">
            üåô
        </button>
    </header>

    <!-- DASHBOARD -->
    <section class="dashboard">
        <div class="dash-card">
            <span>Daily</span>
            <strong>‚Çπ{{ summary_result if summary_type == 'daily' else '‚Äî' }}</strong>
        </div>

        <div class="dash-card">
            <span>Monthly</span>
            <strong>‚Çπ{{ summary_result if summary_type == 'monthly' else '‚Äî' }}</strong>
        </div>

        <div class="dash-card">
            <span>Yearly</span>
            <strong>‚Çπ{{ summary_result if summary_type == 'yearly' else '‚Äî' }}</strong>
        </div>
    </section>

    <!-- SUMMARY CONTROL -->
    <section class="summary-control">
        <form method="POST">
            <select name="summary_type" required>
                <option value="" disabled selected>View expense summary</option>
                <option value="daily">Daily</option>
                <option value="monthly">Monthly</option>
                <option value="yearly">Yearly</option>
            </select>
            <button type="submit" class="ripple">Show</button>
        </form>
    </section>

<!-- ADD / EDIT EXPENSE -->
<section class="card">
    {% if session.get("user_id") %}
        <h2>{{ "Edit Expense" if edit_expense else "Add Expense" }}</h2>

        <form method="POST"
              action="{% if edit_expense %}{{ url_for('edit', expense_id=edit_expense['id']) }}{% else %}/{% endif %}"
              class="expense-form">

            <input type="date" name="date" required
                   value="{{ edit_expense['date'] if edit_expense }}">

            <input type="text" name="category" placeholder="Category" required
                   value="{{ edit_expense['category'] if edit_expense }}">

            <input type="number" name="amount" placeholder="Amount" step="0.01" required
                   value="{{ edit_expense['amount'] if edit_expense }}">

            <input type="text" name="description" placeholder="Description"
                   value="{{ edit_expense['description'] if edit_expense }}">

            <div class="form-actions">
                <button type="submit" class="ripple">
                    {{ "Update" if edit_expense else "Add Expense" }}
                </button>

                {% if edit_expense %}
                    <a href="/" class="cancel ripple">Cancel</a>
                {% endif %}
            </div>
        </form>

    {% else %}
        <h2>Add Expense</h2>
       <p class="muted" style="text-align:center;">
    üîí You must be logged in to add expenses
</p>

<div style="text-align:center;">
    <a href="/login" class="ripple">Login</a>
</div>

    {% endif %}
</section>


    <!-- EXPENSE LIST -->
    <section class="card">
        <h2>Expenses</h2>

        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Description</th>
                    <th>Actions</th>
                </tr>
            </thead>

            <tbody>
                {% for exp in expenses %}
                <tr>
                    <td>{{ exp["date"] }}</td>
                    <td>{{ exp["category"] }}</td>
                    <td class="amount">‚Çπ{{ exp["amount"] }}</td>
                    <td class="muted">{{ exp["description"] }}</td>
                    <td class="actions">
                        {% if session.get("user_id") %}
                            <a href="{{ url_for('edit', expense_id=exp['id']) }}"
                               class="edit-btn ripple">‚úè</a>

                            <form method="POST"
                                  action="{{ url_for('delete', expense_id=exp['id']) }}"
                                  onsubmit="return confirm('Delete this expense?');">
                                <button type="submit" class="delete-btn ripple">üóë</button>
                            </form>
                        {% else %}
                            <span class="muted">Login required</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>

    <!-- CATEGORY TOTALS -->
    <section class="card">
        <h2>Category Totals</h2>

        <div class="category-list">
            {% for row in category_totals %}
            <div class="category-item">
                <span>{{ row["category"] }}</span>
                <strong>‚Çπ{{ row["total"] }}</strong>
            </div>
            {% endfor %}
        </div>
    </section>

</div>

<!-- DARK MODE JS -->
<script>
const toggle = document.getElementById("themeToggle");

if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark");
    toggle.textContent = "‚òÄÔ∏è";
}

toggle.addEventListener("click", () => {
    document.body.classList.toggle("dark");

    if (document.body.classList.contains("dark")) {
        localStorage.setItem("theme", "dark");
        toggle.textContent = "‚òÄÔ∏è";
    } else {
        localStorage.setItem("theme", "light");
        toggle.textContent = "üåô";
    }
});
</script>

</body>
</html>
